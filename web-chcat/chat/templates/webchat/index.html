<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <title>Audio Recorder</title>
    <link href="https://maxcdn.bootstrapcdn.com/bootstrap/4.5.2/css/bootstrap.min.css" rel="stylesheet">
</head>
<body>
    <div class="container mt-5">
        <h1>Record Audio</h1>
        <button id="recordButton" class="btn btn-primary">Start Recording</button>
    </div>

    <script>
        let mediaRecorder;
        let audioChunks = [];

        document.getElementById('recordButton').addEventListener('click', () => {
            const recordButton = document.getElementById('recordButton');
            if (mediaRecorder && mediaRecorder.state === "recording") {
                mediaRecorder.stop();
                recordButton.textContent = "Start Recording";
                recordButton.classList.toggle('btn-danger');
                recordButton.classList.toggle('btn-primary');
            } else {
                navigator.mediaDevices.getUserMedia({ audio: true })
                    .then(stream => {
                        mediaRecorder = new MediaRecorder(stream, { mimeType: 'audio/webm' });
                        if (!MediaRecorder.isTypeSupported('audio/webm')) {
                            console.error('audio/webm not supported');
                            return;
                        }
                        mediaRecorder.start();
                        recordButton.textContent = "Stop Recording";
                        recordButton.classList.toggle('btn-primary');
                        recordButton.classList.toggle('btn-danger');

                        audioChunks = [];
                        mediaRecorder.ondataavailable = e => {
                            console.log('Audio chunk size:', e.data.size);
                            audioChunks.push(e.data);
                        };
                        mediaRecorder.onstop = () => {
                            const audioBlob = new Blob(audioChunks, { type: 'audio/webm' });
                            console.log('Audio Blob size:', audioBlob.size);
                            if (audioBlob.size > 0) {
                                sendAudioToServer(audioBlob);
                            } else {
                                console.error('No data to send.');
                            }
                        };
                    }).catch(error => console.error("Error accessing media devices.", error));
            }
        });

        function sendAudioToServer(audioBlob) {
            const formData = new FormData();
            formData.append('audio', audioBlob, 'filename.webm');
    
            fetch('/upload_audio', {
                method: 'POST',
                body: formData,
            })
            .then(response => response.json())
            .then(data => {
                console.log("Received response:", data);
                if (data.llama_response) {
                    console.log("Llama says:", data.llama_response);
                    speak(data.llama_response);  // Use the speak function here
                }
            })
            .catch(error => console.error('Error uploading the audio:', error));
        }
    
        function speak(text) {
            if (!window.speechSynthesis) {
                console.log('Text-to-speech not supported.');
                return;
            }
            const utterance = new SpeechSynthesisUtterance(text);
            utterance.voice = speechSynthesis.getVoices().find(voice => voice.lang === 'es-ES' || voice.lang.startsWith('es'));
            speechSynthesis.speak(utterance);
        }
    </script>
</body>
</html>
